using Alba.CsConsoleFormat.Fluent;
using ClosedXML.Excel;
using MySql.Data.MySqlClient;
using Npgsql;
using OfficeOpenXml;
using Oracle.DataAccess.Client;
using System;
using System.Collections.Generic;
using System.Configuration;
using System.Data;
using System.Data.SqlClient;
using System.IO;
using System.Linq;
using System.Text;

namespace ViewBLOB
{
    class Program
    {
        private static readonly string exceptionPath = Directory.GetCurrentDirectory() + @"\output\" + @"Exception.txt";
        private static string connectionString;
        private static string datasource;
        private static string csvOutputfilename;

        //private static DataTable dataTable;

        static void Main(string[] args)
        {

            Console.Title = "Schema Information Generation";
            if (!Directory.Exists(@"output"))
            {
                Directory.CreateDirectory(@"output");
            }
            File.Create(exceptionPath).Close();

            try
            {
                connectionString = ConfigurationManager.AppSettings["connectionString"];
                datasource = ConfigurationManager.AppSettings["DataSourceType"];
                csvOutputfilename = ConfigurationManager.AppSettings["DatabaseName"];
            }
            catch (Exception con)
            {

                Console.WriteLine("Exception occurs in app.config {0}", con.Message);
                Console.WriteLine("Program will exit: Press ENTER to exist..");
                Console.ReadLine();

                File.WriteAllText(exceptionPath, con.Message + Environment.NewLine + Environment.NewLine);
                System.Environment.Exit(1);
            }
        
            string scriptPath = "";
            if (datasource.ToUpper() == "SQLSERVER")
            {
                scriptPath = @"Tab_ColumnsSQL.sql";
            }
            else if (datasource.ToUpper() == "ORACLESERVER")
            {
                scriptPath = @"Tab_ColumnsOracle.sql";
            }
            else if (datasource.ToUpper() == "POSTGRESSERVER"){
                scriptPath = @"Tab_Columns_Postgres.sql";
            }
            else if (datasource.ToUpper() == "MYSQLSERVER")
            {
                scriptPath = @"Tab_ColumnsMySQL.sql";
            }

          
            DataTable getdata = new DataTable();
            DataTable data = GetdataTable(connectionString, datasource, scriptPath);
            var tablename = data.Rows.OfType<DataRow>().Select(dr => dr.Field<string>("table_name")).ToList();
            var columnList = data.Rows.OfType<DataRow>().Select(dr => dr.Field<string>("column_name")).ToList();
            getdata.Merge(data);
            DataColumn[] dc = new DataColumn[] {
                new DataColumn("Min", typeof(string)),
                new DataColumn("max", typeof(string)),
                new DataColumn("Retain NULL",typeof(string)),
                new DataColumn("Public", typeof(string)),
                new DataColumn("Personal", typeof(string)),
                new DataColumn("Sensitive",typeof(string)),
                new DataColumn("Masking Rule", typeof(string)),
                 new DataColumn("Rule set by", typeof(string)),
                new DataColumn("Rule Reasoning",typeof(string)),
                new DataColumn("COMPLETED", typeof(string))
                };
            //data.Columns.Add("Min");
            // data.Columns.Add("max");
            //data.Columns.Add("Retain NULL"); 
            data.Columns.AddRange(dc);
            Random random = new Random();
            List<string> rantbool = new List<string>() { "Yes", "No" };
            List<string> isNull = new List<string>() { "TRUE", "FALSE" };
            List<string> completed = new List<string>() { "Completed", "Uncompleted" };
            List<string> MaskingRules = new List<string>() { "No Masking required", "Replace Value with fake data", "Shuffle", "Math", "Flagged", "Scramble"};

            foreach (DataColumn columns in data.Columns)
            {
                foreach (DataRow rows in data.Rows)
                {
                    rows["Retain NULL"] = isNull[random.Next(0, isNull.Count)].ToString(); ;
                    rows["COMPLETED"] = completed[random.Next(0, completed.Count)].ToString(); ;
                    rows["Public"] = rantbool[random.Next(0,rantbool.Count)].ToString();
                    rows["Personal"] = rantbool[random.Next(0, rantbool.Count)].ToString(); ;
                    rows["Sensitive"] = rantbool[random.Next(0, rantbool.Count)].ToString(); ;
                    rows["Rule set by"] = "BA Name";
                    rows["Masking Rule"] = MaskingRules[random.Next(0, MaskingRules.Count)].ToString(); ;
                    if (rows["data_type"].ToString().ToUpper().Contains("DATE"))
                    {
                        string tname = rows["table_name"].ToString();
                        string colname = rows["column_name"].ToString();
                        DataTable dtMinMax = new DataTable();
                        dtMinMax  = GetMinMax(rows["table_name"].ToString(), rows["column_name"].ToString(),connectionString,datasource);
                        if (dtMinMax != null && dtMinMax.Rows.Count > 0)
                        {
                            var min = dtMinMax.Rows.OfType<DataRow>().Select(dr => dr.Field<DateTime?>("Min")).ToList()[0];
                            var max = dtMinMax.Rows.OfType<DataRow>().Select(dr => dr.Field<DateTime?>("Max")).ToList()[0];
                            rows["Min"] = min;
                            rows["Max"] = max;
                            data.AcceptChanges();
                        }
                       
                    }
                    else if (rows["data_type"].ToString().ToUpper().Contains("NUMBER") || rows["data_type"].ToString().ToUpper().Contains("MONEY") || rows["data_type"].ToString().ToUpper().Contains("DECIMAL"))
                    {
                        string tname = rows["table_name"].ToString();
                        string colname = rows["column_name"].ToString();
                        DataTable dtMinMax = new DataTable();
                        dtMinMax = GetMinMax(rows["table_name"].ToString(), rows["column_name"].ToString(), connectionString, datasource);
                        if (dtMinMax != null && dtMinMax.Rows.Count > 0)
                        {
                            var min = dtMinMax.Rows.OfType<DataRow>().Select(dr => dr.Field<decimal?>("MIN")).ToList()[0];
                            var max = dtMinMax.Rows.OfType<DataRow>().Select(dr => dr.Field<decimal?>("MAX")).ToList()[0];
                            rows["Min"] = min;
                            rows["Max"] = max;
                            data.AcceptChanges();
                        }
                     
                    }
                    else if (rows["data_type"].ToString().ToUpper().Contains("FLOAT"))
                    {
                        string tname = rows["table_name"].ToString();
                        string colname = rows["column_name"].ToString();
                        DataTable dtMinMax = new DataTable();
                        dtMinMax = GetMinMax(rows["table_name"].ToString(), rows["column_name"].ToString(), connectionString, datasource);
                        if (dtMinMax != null && dtMinMax.Rows.Count > 0)
                        {
                            var min = dtMinMax.Rows.OfType<DataRow>().Select(dr => dr.Field<double?>("MIN")).ToList()[0];
                            var max = dtMinMax.Rows.OfType<DataRow>().Select(dr => dr.Field<double?>("MAX")).ToList()[0];
                            rows["Min"] = min;
                            rows["Max"] = max;
                            data.AcceptChanges();
                        }

                    }
                    else if (rows["data_type"].ToString().ToUpper().Contains("BIT"))
                    {
                        string tname = rows["table_name"].ToString();
                        string colname = rows["column_name"].ToString();
                        DataTable dtMinMax = new DataTable();
                        dtMinMax = GetMinMax(rows["table_name"].ToString(), rows["column_name"].ToString(), connectionString, datasource);
                        if (dtMinMax != null && dtMinMax.Rows.Count > 0)
                        {
                            var min = dtMinMax.Rows.OfType<DataRow>().Select(dr => dr.Field<bool?>("MIN")).ToList()[0];
                            var max = dtMinMax.Rows.OfType<DataRow>().Select(dr => dr.Field<bool?>("MAX")).ToList()[0];
                            rows["Min"] = min;
                            rows["Max"] = max;
                            data.AcceptChanges();
                        }

                    }
                    else if (rows["data_type"].ToString().ToUpper().Equals("INT") || rows["data_type"].ToString().ToUpper().Equals("INTEGER"))
                    {
                        string tname = rows["table_name"].ToString();
                        string colname = rows["column_name"].ToString();
                        DataTable dtMinMax = new DataTable();
                        dtMinMax = GetMinMax(rows["table_name"].ToString(), rows["column_name"].ToString(), connectionString, datasource);
                        if (dtMinMax != null && dtMinMax.Rows.Count > 0)
                        {
                            var min = dtMinMax.Rows.OfType<DataRow>().Select(dr => dr.Field<int?>("MIN")).ToList()[0];
                            var max = dtMinMax.Rows.OfType<DataRow>().Select(dr => dr.Field<int?>("MAX")).ToList()[0];
                            rows["Min"] = min;
                            rows["Max"] = max;
                            data.AcceptChanges();
                        }

                    }
                    else if (rows["data_type"].ToString().ToUpper().Contains("VARCHAR2") || rows["data_type"].ToString().ToUpper().Contains("VARCHAR") || rows["data_type"].ToString().ToLower().Contains("character") || rows["data_type"].ToString().ToLower().Contains("text"))                    {
                        string tname = rows["table_name"].ToString();
                        string colname = rows["column_name"].ToString();
                        DataTable dtMinMax = new DataTable();
                        dtMinMax = GetMinMax(rows["table_name"].ToString(), rows["column_name"].ToString(), connectionString, datasource);
                        if (dtMinMax != null && dtMinMax.Rows.Count > 0)
                        {
                            //var min = dtMinMax.Rows.OfType<DataRow>().Select(dr => dr.Field<decimal?>("MIN")).ToList()[0];
                            var tt = dtMinMax;
                           
                            var MaxNvarchar = dtMinMax.Rows.OfType<DataRow>().Select(dr => dr.Field<object>("MaxNvarchar")).ToList()[0];
                            //rows["Min"] = min;
                            rows["Max"] = MaxNvarchar;
                            data.AcceptChanges();
                        }
                        
                    }
                    else
                    {

                    }

                }
            }

            //write to excel
            XLWorkbook wb = new XLWorkbook();
            //wb.Worksheets.Add()

            //write to csv
            if (data.Rows != null)
            {
                DataTableToExcle(data, csvOutputfilename, csvOutputfilename);               
                data.PrintList(true, 50);
                Colors.WriteLine("Total Columns: ".Red() ,data.Rows.Count.ToString().Yellow());

                Console.WriteLine("Hit Enter to Continue".ToUpper());
                Console.ReadLine();
                //exportToExcel(data, "APP_GWP");
            }

        }
        private static void DataTableToExcle(DataTable dataTable,string directory, string _tablename)
        {
             dataTable.TableName = _tablename;
        
            try
            {
                //HttpContext.Current.Response.Clear();
                if (!Directory.Exists(directory))
                {
                    Directory.CreateDirectory(directory);
                }

                var format = new ExcelTextFormat
                {
                    EOL = "\r\n"
                };
                using (ExcelPackage pack = new ExcelPackage())
                {
                    ExcelWorksheet ws = pack.Workbook.Worksheets.Add(dataTable.TableName);
                    ws.Cells["A1"].LoadFromDataTable(dataTable, true, OfficeOpenXml.Table.TableStyles.Medium28);
                    var ms = new System.IO.MemoryStream();
                    pack.SaveAs(new FileInfo(directory + @"\" + directory + ".xlsx"));

                }
            }
            catch (Exception ex)
            {
               Console.WriteLine(ex) ;
                Console.WriteLine("Hit enter to exit");
                Console.ReadLine();
            }
        }
        private static void WriteTofile(DataTable textTable, string directory)
        {
            StringBuilder fileContent = new StringBuilder();
            //int i = 0;
            if (!Directory.Exists(directory))
            {
                Directory.CreateDirectory(directory);
            }
            if (textTable.Columns.Count == 0)
            {
                return;
            }
            foreach (var col in textTable.Columns)
            {
                fileContent.Append(col.ToString() + ",");
            }

            fileContent.Replace(",", System.Environment.NewLine, fileContent.Length - 1, 1);

            foreach (DataRow dr in textTable.Rows)
            {
                foreach (var column in dr.ItemArray)
                {
                    fileContent.Append("\"" + column.ToString() + "\",");
                }

                fileContent.Replace(",", System.Environment.NewLine, fileContent.Length - 1, 1);
            }
            Console.WriteLine(directory);
            Console.ReadLine();
            Console.WriteLine(Directory.GetCurrentDirectory() + @"\" + directory + @"\" + directory + ".csv");
            Console.ReadLine();
            System.IO.File.WriteAllText(directory + @"\" + directory + ".csv", fileContent.ToString());

        }
        private static DataTable GetdataTable(string connectionString1,string datasource, string scriptpath)
        {
            DataTable dataTable = new DataTable();
            if (datasource.ToUpper() == "ORACLESERVER")
            {
                using (OracleConnection oracleConnection = new OracleConnection(connectionString1))
                {
                    string squery = File.ReadAllText(scriptpath);
                    //System.Collections.Generic.IEnumerable<string> commandStrings = Regex.Split(squery, @"^\s*GO\s*$",
                    //RegexOptions.Multiline | RegexOptions.IgnoreCase);


                    try
                    {
                        oracleConnection.Open();
                    }
                    catch (Exception e)
                    {
                        Console.WriteLine("Exception occurs {0}", e.Message);
                        Console.WriteLine("Program will exit: Press ENTER to exist..");
                        Console.ReadLine();
                       
                        File.WriteAllText(exceptionPath, e.Message + Environment.NewLine + Environment.NewLine);
                        System.Environment.Exit(1);
                    }
                    using (OracleDataAdapter oda = new OracleDataAdapter(squery, oracleConnection))
                    {
                        try
                        {
                            //Fill the data table with select statement's query results:
                            int recordsAffectedSubscriber = 0;

                            recordsAffectedSubscriber = oda.Fill(dataTable);

                        }
                        catch (Exception ex)
                        {

                            File.WriteAllText(exceptionPath, ex.Message + Environment.NewLine + Environment.NewLine);
                            
                        }
                    }

                    return dataTable;

                }
            }
            else if (datasource.ToUpper() == "SQLSERVER")
            {
                using (SqlConnection SqlConnection = new SqlConnection(connectionString1))
                {
                    string squery = File.ReadAllText(scriptpath);
                    //System.Collections.Generic.IEnumerable<string> commandStrings = Regex.Split(squery, @"^\s*GO\s*$",
                    //RegexOptions.Multiline | RegexOptions.IgnoreCase);


                    try
                    {
                        SqlConnection.Open();
                    }
                    catch (Exception e)
                    {
                        Console.WriteLine("Exception occurs {0}", e.Message);
                        Console.WriteLine("Program will exit: Press ENTER to exist..");
                        Console.ReadLine();
                        
                        File.WriteAllText(exceptionPath, e.Message + Environment.NewLine + Environment.NewLine);
                        System.Environment.Exit(1);
                    }
                    using (SqlDataAdapter oda = new SqlDataAdapter(squery, SqlConnection))
                    {
                        try
                        {
                            //Fill the data table with select statement's query results:
                            int recordsAffectedSubscriber = 0;

                            recordsAffectedSubscriber = oda.Fill(dataTable);

                        }
                        catch (Exception ex)
                        {

                            File.WriteAllText(exceptionPath, ex.Message + Environment.NewLine + Environment.NewLine);
                        }
                    }

                    return dataTable;

                }
            }
            else if (datasource.ToUpper() == "POSTGRESSERVER")
            {
                using (NpgsqlConnection postgreConnection = new NpgsqlConnection(connectionString1))
                {
                    string squery = File.ReadAllText(scriptpath);
                    //System.Collections.Generic.IEnumerable<string> commandStrings = Regex.Split(squery, @"^\s*GO\s*$",
                    //RegexOptions.Multiline | RegexOptions.IgnoreCase);
                    try
                    {
                        postgreConnection.Open();
                    }
                    catch (Exception e)
                    {
                        Console.WriteLine("Exception occurs {0}", e.Message);
                        Console.WriteLine("Program will exit: Press ENTER to exist..");
                        Console.ReadLine();
                      
                        File.WriteAllText(exceptionPath, e.Message + Environment.NewLine + Environment.NewLine);
                        System.Environment.Exit(1);
                    }
                 
                    using (NpgsqlDataAdapter oda = new NpgsqlDataAdapter(squery, postgreConnection))
                    {
                        try
                        {
                            //Fill the data table with select statement's query results:
                            int recordsAffectedSubscriber = 0;

                            recordsAffectedSubscriber = oda.Fill(dataTable);

                        }
                        catch (Exception ex)
                        {
                            File.WriteAllText(exceptionPath, ex.Message + Environment.NewLine + Environment.NewLine);
                        }
                    }

                    return dataTable;

                }
            }
            else if (datasource.ToUpper() == "MYSQLSERVER")
            {
                using (MySqlConnection mySQLConnection = new MySqlConnection(connectionString1))
                {
                    string squery = File.ReadAllText(scriptpath);
                    //System.Collections.Generic.IEnumerable<string> commandStrings = Regex.Split(squery, @"^\s*GO\s*$",
                    //RegexOptions.Multiline | RegexOptions.IgnoreCase);

                    try
                    {
                        mySQLConnection.Open();
                    }
                    catch (Exception e)
                    {
                        Console.WriteLine("Exception occurs {0}", e.Message);
                        Console.WriteLine("Program will exit: Press ENTER to exist..");
                        Console.ReadLine();
                       
                        File.WriteAllText(exceptionPath, e.Message + Environment.NewLine + Environment.NewLine);
                        System.Environment.Exit(1);
                    }
                    using (MySqlDataAdapter oda = new MySqlDataAdapter(squery, mySQLConnection))
                    {
                        try
                        {
                            //Fill the data table with select statement's query results:
                            int recordsAffectedSubscriber = 0;

                            recordsAffectedSubscriber = oda.Fill(dataTable);

                        }
                        catch (Exception ex)
                        {

                            File.WriteAllText(exceptionPath, ex.Message + Environment.NewLine + Environment.NewLine);
                        }
                    }

                    return dataTable;

                }
            }
            else
                return null;

        }
        private static DataTable GetMinMax(string table, string column, string connectionString1,string DataSource)
        {
            DataTable dataTable = new DataTable();
            string schema = ConfigurationManager.AppSettings["schema"];
            if (DataSource == "OracleServer")
            {
                using (OracleConnection oracleConnection = new OracleConnection(connectionString1))
                {
                    string squery = "Select Min(" + column + ") as Min, Max(" + column + ") as Max, Max(Length(" + column + ")) as MaxNvarchar  from " + table;



                    //System.Collections.Generic.IEnumerable<string> commandStrings = Regex.Split(squery, @"^\s*GO\s*$",
                    //RegexOptions.Multiline | RegexOptions.IgnoreCase);
                    try
                    {
                        oracleConnection.Open();
                    }
                    catch (Exception e)
                    {
                        Console.WriteLine("Exception occurs {0}", e.Message);
                        Console.WriteLine("Program will exit: Press ENTER to exist..");
                        Console.ReadLine();
                        File.WriteAllText(exceptionPath, e.Message + Environment.NewLine + Environment.NewLine); 
                        System.Environment.Exit(1);
                    }
          
                    using (OracleDataAdapter oda = new OracleDataAdapter(squery, oracleConnection))
                    {
                        try
                        {
                            //Fill the data table with select statement's query results:
                            int recordsAffectedSubscriber = 0;

                            recordsAffectedSubscriber = oda.Fill(dataTable);

                        }
                        catch (Exception ex)
                        {

                            File.AppendAllText(exceptionPath, ex.Message + Environment.NewLine + Environment.NewLine);
                        }
                    }
                    //int FileSize = 0;
                    return dataTable;
                }
            }
            else if (DataSource == "SqlServer")
            {
                using (SqlConnection SqlConnection = new SqlConnection(connectionString1))
                {
                    string squery = "Select Min(" + column + ") as Min, Max(" + column + ") as Max, Max(Len(" + column + ")) as MaxNvarchar  from " + table;
                    //System.Collections.Generic.IEnumerable<string> commandStrings = Regex.Split(squery, @"^\s*GO\s*$",
                    //RegexOptions.Multiline | RegexOptions.IgnoreCase);
                    try
                    {
                        SqlConnection.Open();
                    }
                    catch (Exception e)
                    {
                        Console.WriteLine("Exception occurs {0}", e.Message);
                        Console.WriteLine("Program will exit: Press ENTER to exist..");
                        Console.ReadLine();
                        File.WriteAllText(exceptionPath, e.Message + Environment.NewLine + Environment.NewLine);
                        System.Environment.Exit(1);
                    }
                    
                    using (SqlDataAdapter oda = new SqlDataAdapter(squery, SqlConnection))
                    {
                        try
                        {
                            //Fill the data table with select statement's query results:
                            int recordsAffectedSubscriber = 0;

                            recordsAffectedSubscriber = oda.Fill(dataTable);

                        }
                        catch (Exception ex)
                        {

                            File.AppendAllText(exceptionPath, ex.Message + Environment.NewLine + Environment.NewLine);
                        }
                    }
                    //int FileSize = 0;
                    return dataTable;
                }
            }
            else if(DataSource.ToUpper() == "PostgresServer".ToUpper())
            {
                using (NpgsqlConnection postgresConnection = new NpgsqlConnection(connectionString1))
                {
                    string squery = $"Select Min({column}) as Min, Max({column}) as Max, (select character_maximum_length from information_schema.columns  where table_schema = '{schema}' and column_name = '{column}' and table_name = '{table}') as MaxNvarchar  from " + table;
                    //System.Collections.Generic.IEnumerable<string> commandStrings = Regex.Split(squery, @"^\s*GO\s*$",
                    //RegexOptions.Multiline | RegexOptions.IgnoreCase);
                    try
                    {
                        postgresConnection.Open();
                    }
                    catch (Exception e)
                    {

                        Console.WriteLine("Exception occurs {0}", e.Message);
                        Console.WriteLine("Program will exit: Press ENTER to exist..");
                        Console.ReadLine();
                        File.WriteAllText(exceptionPath, e.Message + Environment.NewLine + Environment.NewLine);
                        System.Environment.Exit(1);
                    }
                  
                    using (NpgsqlDataAdapter oda = new NpgsqlDataAdapter(squery, postgresConnection))
                    {
                        try
                        {
                            //Fill the data table with select statement's query results:
                            int recordsAffectedSubscriber = 0;

                            recordsAffectedSubscriber = oda.Fill(dataTable);

                        }
                        catch (Exception ex)
                        {

                            File.AppendAllText(exceptionPath, ex.Message + Environment.NewLine + Environment.NewLine);
                        }
                    }
                    //int FileSize = 0;
                    return dataTable;
                }
            }
            else if (DataSource.ToUpper() == "MYSQLSERVER")
            {
                using (MySqlConnection mySqlConnection = new MySqlConnection(connectionString1))
                {
                    //string squery = $"Select Min({column}) as Min, Max({column}) as Max, (select character_maximum_length from information_schema.columns  where table_schema = '{schema}' and column_name = '{column}' and table_name = '{table}') as MaxNvarchar  from " + table;
                    string squery = "Select Min(" + column + ") as Min, Max(" + column + ") as Max, Max(Length(" + column + ")) as MaxNvarchar  from " + table;

                    //System.Collections.Generic.IEnumerable<string> commandStrings = Regex.Split(squery, @"^\s*GO\s*$",
                    //RegexOptions.Multiline | RegexOptions.IgnoreCase);
                    try
                    {
                        mySqlConnection.Open();
                    }
                    catch (Exception e)
                    {
                        Console.WriteLine("Exception occurs {0}", e.Message);
                        Console.WriteLine("Program will exit: Press ENTER to exist..");
                        Console.ReadLine();
                        File.WriteAllText(exceptionPath, e.Message + Environment.NewLine + Environment.NewLine);
                        System.Environment.Exit(1);
                    }
                
                    using (MySqlDataAdapter oda = new MySqlDataAdapter(squery, mySqlConnection))
                    {
                        try
                        {
                            //Fill the data table with select statement's query results:
                            int recordsAffectedSubscriber = 0;

                            recordsAffectedSubscriber = oda.Fill(dataTable);

                        }
                        catch (Exception ex)
                        {

                            File.AppendAllText(exceptionPath, ex.Message + Environment.NewLine + Environment.NewLine);
                        }
                    }
                    //int FileSize = 0;
                    return dataTable;
                }
            }
            else
            {
                return null;
            }
           
        }
    }
}
